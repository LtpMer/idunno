<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Chat</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #E5E7EB;
        }
        .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 8rem);
            padding-bottom: 1rem;
            overflow-y: auto;
        }
        .chat-container::-webkit-scrollbar {
            width: 8px;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background-color: #4a5568;
            border-radius: 4px;
        }
        .chat-container::-webkit-scrollbar-track {
            background-color: #2d3748;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <!-- Loading screen -->
    <div id="loadingScreen" class="flex items-center justify-center min-h-screen">
        <div class="text-lg">Connecting to the chat...</div>
    </div>

    <!-- Authentication Form -->
    <div id="authForm" class="hidden flex flex-col items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-md bg-gray-800 rounded-lg shadow-lg p-8">
            <h2 id="authTitle" class="text-2xl font-bold text-center mb-6">Log In</h2>
            <div id="authError" class="hidden bg-red-900 text-red-300 p-3 rounded-md mb-4 text-center"></div>
            <form id="authFormElement" class="space-y-4">
                <!-- Username field -->
                <input type="text" id="usernameInput" placeholder="Username" class="w-full p-3 rounded-lg bg-gray-700 text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <!-- Password field -->
                <input type="password" id="passwordInput" placeholder="Password" class="w-full p-3 rounded-lg bg-gray-700 text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <!-- Login/Sign Up button -->
                <button type="submit" id="authButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg transition-colors duration-200">Log In</button>
            </form>
            <button id="toggleAuthView" class="w-full mt-4 text-sm text-blue-400 hover:underline">Need an account? Sign Up</button>
        </div>
    </div>

    <!-- Chat Interface -->
    <div id="chatUI" class="hidden flex flex-col h-screen p-4">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-xl font-bold">Simple Chat</h1>
            <button id="logoutButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-colors duration-200">Logout</button>
        </div>

        <!-- Voice chat and file sharing placeholders -->
        <div class="mb-4 text-center">
            <!-- Voice Chat Stub -->
            <div class="inline-block relative group">
                <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-colors duration-200 mr-2">
                    Join Voice Chat
                </button>
                <span class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 p-2 text-xs text-white bg-gray-800 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none w-max">
                    Requires a dedicated backend
                </span>
            </div>
            <!-- File Sharing Stub -->
            <label class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg cursor-pointer transition-colors duration-200 inline-block relative group">
                Share File
                <input type="file" class="hidden">
                <span class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 p-2 text-xs text-white bg-gray-800 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none w-max">
                    Requires a storage solution
                </span>
            </label>
        </div>

        <!-- Main chat messages container -->
        <div id="messagesContainer" class="chat-container border border-gray-700 rounded-lg p-4 mb-4">
            <div class="text-center text-gray-500 italic">Start the conversation!</div>
        </div>

        <!-- Input form for new messages -->
        <form id="messageForm" class="flex space-x-2">
            <input type="text" id="messageInput" placeholder="Type a message..." class="flex-grow p-3 rounded-lg bg-gray-800 text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button type="submit" id="sendButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-colors duration-200">Send</button>
        </form>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, doc, setDoc, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your specific Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB4fdAn05-TaVzTpcWosN2sCrkpOIIac_4",
            authDomain: "chat-2177d.firebaseapp.com",
            projectId: "chat-2177d",
            storageBucket: "chat-2177d.firebasestorage.app",
            messagingSenderId: "169031097143",
            appId: "1:169031097143:web:eb501bc1b90eed907258b2"
        };
        
        // DOM elements
        const loadingScreen = document.getElementById('loadingScreen');
        const authForm = document.getElementById('authForm');
        const chatUI = document.getElementById('chatUI');
        const authFormElement = document.getElementById('authFormElement');
        const authTitle = document.getElementById('authTitle');
        const authButton = document.getElementById('authButton');
        const authError = document.getElementById('authError');
        const toggleAuthViewButton = document.getElementById('toggleAuthView');
        const usernameInput = document.getElementById('usernameInput');
        const passwordInput = document.getElementById('passwordInput');
        const logoutButton = document.getElementById('logoutButton');
        const messagesContainer = document.getElementById('messagesContainer');
        const messageForm = document.getElementById('messageForm');
        const messageInput = document.getElementById('messageInput');

        // Firebase variables
        let db;
        let auth;
        let userId = null;
        let usersData = {};
        let isLoginView = true;

        // Function to scroll to the bottom of the chat
        const scrollToBottom = () => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        };

        // Function to display the correct UI based on user's login state
        const showUI = (loggedIn) => {
            loadingScreen.classList.add('hidden');
            if (loggedIn) {
                authForm.classList.add('hidden');
                chatUI.classList.remove('hidden');
            } else {
                authForm.classList.remove('hidden');
                chatUI.classList.add('hidden');
            }
        };

        // Function to show authentication errors
        const showError = (message) => {
            authError.textContent = message;
            authError.classList.remove('hidden');
        };
        
        // Function to hide authentication errors
        const hideError = () => {
            authError.classList.add('hidden');
        };

        // Function to handle user registration
        const handleRegister = async (e) => {
            e.preventDefault();
            hideError();
            const username = usernameInput.value.trim();
            const password = passwordInput.value;

            if (username === '') {
                showError("Username cannot be empty.");
                return;
            }

            // Check if the username already exists in Firestore
            try {
                const usersCollectionPath = `artifacts/${firebaseConfig.projectId}/public/data/users`;
                const usersQuery = query(collection(db, usersCollectionPath), where("displayName", "==", username));
                const querySnapshot = await getDocs(usersQuery);

                if (!querySnapshot.empty) {
                    showError("Username is already taken. Please choose a different one.");
                    return;
                }

                // If username is unique, proceed with creating the user
                // We use a dummy email since Firebase Auth requires an email
                const email = `${username}@temp.chat-app.com`;
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Store the username in Firestore
                await setDoc(doc(db, usersCollectionPath, user.uid), {
                    displayName: username
                });

            } catch (err) {
                console.error("Registration error:", err);
                showError(err.message);
            }
        };

        // Function to handle user login
        const handleLogin = async (e) => {
            e.preventDefault();
            hideError();
            const username = usernameInput.value.trim();
            const password = passwordInput.value;

            // Use the same dummy email logic for authentication
            const email = `${username}@temp.chat-app.com`;

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (err) {
                console.error("Login error:", err);
                showError("Invalid username or password.");
            }
        };

        // Function to handle user logout
        const handleLogout = async () => {
            try {
                await signOut(auth);
                messagesContainer.innerHTML = `<div class="text-center text-gray-500 italic">Start the conversation!</div>`;
                messageInput.value = '';
            } catch (err) {
                console.error("Logout error:", err);
            }
        };

        // Function to send a new message
        const sendMessage = async (e) => {
            e.preventDefault();
            const messageText = messageInput.value.trim();
            if (messageText === '' || !db || !userId) {
                return;
            }
            try {
                const messagesCollectionPath = `artifacts/${firebaseConfig.projectId}/public/data/chat_messages`;
                
                await addDoc(collection(db, messagesCollectionPath), {
                    text: messageText,
                    userId: userId,
                    createdAt: serverTimestamp(),
                });
                messageInput.value = '';
            } catch (err) {
                console.error("Error sending message:", err);
            }
        };

        // Function to render messages
        const renderMessages = (messages) => {
            messagesContainer.innerHTML = ''; // Clear existing messages
            if (messages.length === 0) {
                messagesContainer.innerHTML = `<div class="text-center text-gray-500 italic">Start the conversation!</div>`;
                return;
            }
            messages.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'p-3 my-2 rounded-lg bg-gray-700 hover:bg-gray-600 transition-colors duration-200';
                
                const senderName = usersData[message.userId] || 'Unknown User';
                const senderDisplay = message.userId === userId ? 'You' : senderName;
                const timestamp = message.createdAt?.toDate().toLocaleTimeString() || 'Just now';

                const headerDiv = document.createElement('div');
                headerDiv.className = 'flex items-center';
                headerDiv.innerHTML = `<span class="text-sm font-semibold text-gray-400 mr-2">${senderDisplay}</span> <span class="text-xs text-gray-500">${timestamp}</span>`;
                
                const p = document.createElement('p');
                p.className = 'mt-1 text-gray-100 break-words';
                
                // Format text with links
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                const parts = message.text.split(urlRegex);
                parts.forEach(part => {
                    if (part.match(urlRegex)) {
                        const link = document.createElement('a');
                        link.href = part;
                        link.textContent = part;
                        link.target = '_blank';
                        link.rel = 'noopener noreferrer';
                        link.className = 'text-blue-500 hover:underline';
                        p.appendChild(link);
                    } else {
                        p.appendChild(document.createTextNode(part));
                    }
                });
                
                messageDiv.appendChild(headerDiv);
                messageDiv.appendChild(p);
                messagesContainer.appendChild(messageDiv);
            });
            scrollToBottom();
        };

        // Main initialization logic
        window.onload = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Set up the real-time listeners for user data and messages
                const usersCollectionPath = `artifacts/${firebaseConfig.projectId}/public/data/users`;
                onSnapshot(collection(db, usersCollectionPath), (querySnapshot) => {
                    const fetchedUsers = {};
                    querySnapshot.forEach((doc) => {
                        fetchedUsers[doc.id] = doc.data().displayName;
                    });
                    usersData = fetchedUsers;
                });

                const messagesCollectionPath = `artifacts/${firebaseConfig.projectId}/public/data/chat_messages`;
                onSnapshot(collection(db, messagesCollectionPath), (querySnapshot) => {
                    const fetchedMessages = [];
                    querySnapshot.forEach((doc) => {
                        fetchedMessages.push({ id: doc.id, ...doc.data() });
                    });
                    fetchedMessages.sort((a, b) => a.createdAt?.toMillis() - b.createdAt?.toMillis());
                    renderMessages(fetchedMessages);
                });

                // Listen for auth state changes to toggle UI
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        showUI(true);
                    } else {
                        userId = null;
                        showUI(false);
                    }
                });

            } catch (err) {
                console.error("Firebase initialization failed:", err);
                showError("Firebase initialization failed. Check console for details.");
            }
        };

        // Event listeners for forms and buttons
        toggleAuthViewButton.addEventListener('click', () => {
            isLoginView = !isLoginView;
            authTitle.textContent = isLoginView ? 'Log In' : 'Sign Up';
            authButton.textContent = isLoginView ? 'Log In' : 'Sign Up';
            usernameInput.value = '';
            passwordInput.value = '';
            hideError();
        });

        authFormElement.addEventListener('submit', (e) => {
            if (isLoginView) {
                handleLogin(e);
            } else {
                handleRegister(e);
            }
        });

        logoutButton.addEventListener('click', handleLogout);
        messageForm.addEventListener('submit', sendMessage);

    </script>
</body>
</html>
